  private static ServletContext createFakeServletContext(
      final Map<String, Object> attributes) {
    InvocationHandler handler = new InvocationHandler() {
      public Object invoke(Object object, Method method, Object[] objects)
          throws Throwable {
        if (method.getName().equals("setAttribute")) {
          attributes.put((String) objects[0], objects[1]);
          return null;
        }
        if (method.getName().equals("getAttribute")) {
          return attributes.get(objects[0]);
        }
        if (method.getName().equals("removeAttribute")) {
          attributes.remove(objects[0]);
          return null;
        }
        throw new UnsupportedOperationException();
      }
    };

    return (ServletContext) Proxy.newProxyInstance(
        ServletContext.class.getClassLoader(),
        new Class[] { ServletContext.class },
        handler);
  }

