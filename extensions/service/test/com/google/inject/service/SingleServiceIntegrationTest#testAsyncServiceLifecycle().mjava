  public final void testAsyncServiceLifecycle() throws InterruptedException {
    ExecutorService executor = Executors.newSingleThreadExecutor();

    final CountDownLatch startLatch = new CountDownLatch(1);
    final CountDownLatch stopLatch = new CountDownLatch(1);
    AsyncService service = new AsyncService(executor) {
      @Override protected void onStart() {
        assertEquals(1, startLatch.getCount());
        assertEquals(1, stopLatch.getCount());

        startLatch.countDown();
      }

      @Override protected void onStop() {
        assertEquals(0, startLatch.getCount());
        assertEquals(1, stopLatch.getCount());

        stopLatch.countDown();
      }
    };

    service.start();
    // This should not pass!
    assertTrue(startLatch.await(2, TimeUnit.SECONDS));

    service.stop();
    assertTrue(stopLatch.await(2, TimeUnit.SECONDS));

    executor.shutdown();
    assertEquals(0, startLatch.getCount());
    assertEquals(0, stopLatch.getCount());
  }

